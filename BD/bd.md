# 基本設計書

## システム構成

物理サーバは用意せず、AWSのクラウドサービスを使用する。

* クライアント構成
![クライアント](./img/d2dedab2-0d79-0489-e45b-434d32bb8608.png) 

参考 [【AWS】S3+CloudFront+Route53+ACMでSSL化(https)した静的Webサイトを公開する](https://zenn.dev/wakkunn/articles/66a6e8372611dc)

* バックエンド構成
```
---------------
| クライアント |
---------------
      | ↑
------|-|---------------------
| AWS | |                    |
| ----|-|------------------- |
| | --↓-|--       -------  | |
| | | EC2 |  ←-→  | RDS |  | |
| | --|-↑--       -------  | |
| | --↓-|--                | |
| | | SES |                | |
| | -------                | |
| -------------------------- |
------------------------------
```

EC2の中でk8sを構築する。

EC2とクライアントとの間にLBを入れるかどうか？ ★TODO

補足:本来であればECSを使った方が良いが利用料金が高くなりそうなので初期開発では行わない。

## NW構成

* アクセスポイント一覧

| サーバ端点  | ドメイン         | IPアドレス | ポート       | 外部公開 | 備考                           |
| ------ | ------------ | ------ | --------- | ---- | ---------------------------- |
| クライアント | studieee.com | 未定     | 443       | 〇    |                              |
| EC2    | AWSデフォルトドメイン | -      | 443       | 〇    |                              |
| EC2    | AWSデフォルトドメイン | -      | 22        | 〇    | SSHポートの予定だがセキュアにアクセス出来る方法を検討 |
| RDS    | AWSデフォルトドメイン | -      | 5432      | ×    |                              |
| SES    | AWSデフォルトドメイン | -      | 465, 2645 | ×    | AWSのSMTPポートに準拠               |

* 通信方向一覧

| 起点     | 終点  |
| ------ | --- |
| クライアント | EC2 |
| EC2    | RDS |
| EC2    | SES |

起点側は終点側に対してアウトバウンドを許可し、終点側は起点側のサーバのインバウンドを許可する。

## ユースケース

* アカウント登録
  * studieeeにアクセスしアカウント登録をすることが出来る。
  * アカウント登録時に確認メールがユーザーの元に届き承認を押すと本登録が完了する。
  * 認証後Zoom API Keyの発行をする。
* ログイン
  * studieeeにアクセスしログインすることが出来る。
  * ログインの手段は２つあり、studieeeの認証を使う場合とGoogleのOAuthを使う。
* プロフィール編集
  * ユーザーは自分のPWを変更することが出来る。
* タスク計画
  * タスクを計画し運営にお金を払うことが出来る。
  * タスクの計画と同時にZoomの会議のURLを発行され、Googleカレンダーに登録される。
* タスク通知
  * ユーザーはタスクの開始時間を通知することが出来る。
  * 何分に通知するかは自分で選ぶことが出来る。
* タスク完了
  * タスク完了後お金を返金するかどうかを選べる。
* タスク実行履歴
  * 累計のタスク実行履歴を行った履歴を確認することが出来る。
* Zoom APIの発行手順確認
  * ユーザーはZoomのAPI発行手順を確認することが出来る。

## 機能一覧


## ソフトウェア構成

## エラー方針
* クライアントサイド、サーバサイド両方でバリデーションチェックをすること。
* エラーメッセージは、クライアントサイド、サーバサイド両方で持つ。クライアントで完結するエラーの場合は、クライアントサイドで持っているエラーメッセージを表示し、サーバからエラーのレスポンスが返却された場合は、その情報を表示する。

## セキュリティ方針
* クライアントからの入力値をそのままサーバ側でSQL発行に使わないこと（SQLインジェクション対策）。
```
例）
   NG：
    Query query = em.createQuery("SELECT b FROM Book b WHERE b.title = '" + param + "'");
    List<Book> books = query.getResultList();
    return books.size();

   OK：
    Query query = em.createQuery("SELECT b FROM Book b WHERE b.title = :param");
    query.setParameter("param", param);
    List<Book> books = query.getResultList();
    return books.size();

paramは必ずプレースホルダー（:param）にバインド（割り当てる）する。
```


